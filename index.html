<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Projekt zaliczeniowy - Bruno Talaga</title>
</head>
<body>
    <h2>Projekt zaliczeniowy - Bruno Talaga</h2>
    <div id="variable_table" class="default_segment">
        <p>Tabela wartości</p>
        <table class="default_table">
            <tr><th>AX</th><th>BX</th><th>CX</th><th>DX</th></tr>
            <tr>
                <td id="ax_val"></td>
                <td id="bx_val"></td>
                <td id="cx_val"></td>
                <td id="dx_val"></td>
            </tr>
        </table>
        <button type="button" name="empty_table" id="empty_first" value="Wyzeruj" onclick="emptyTable(0)">Wyzeruj</button>
        <button type="button" name="randomize_table" id="randomize_first" value="Wypełnij losowo" onclick="randomizeTable(0)">Wypełnij losowo</button>
        <table class="default_table">
            <tr>
                <th>BP</th>
                <th>DI</th>
                <th>SI</th>
                <th>DISP</th>
            </tr>
            <tr>
                <td id="bp_val"></td>
                <td id="di_val"></td>
                <td id="si_val"></td>
                <td id="offset_val"></td>
            </tr>
        </table>
        <button type="button" name="empty_table" id="empty_second" value="Wyzeruj" onclick="emptyTable(1)">Wyzeruj</button>
        <p>Stos: </p><span>SP: </span><span id="stack_return"></span>
    </div>
    <div id="operations" class="default_segment">
        <p>Pole komend</p>
        <select name="variable_help" id="variable_help">
            <option value="AX">AX</option>
            <option value="BX">BX</option>
            <option value="CX">CX</option>
            <option value="DX">DX</option>
            <option value="BP">BP</option>
            <option value="DI">DI</option>
            <option value="SI">SI</option>
            <option value="DISP">DISP</option>
        </select>
        <button type="button" name="insert_arg" id="insert_first_arg" value="Wpisz jako pierwszy" onclick="insertVariableToInput(`arg_first`, `variable_help`)">Wpisz jako pierwszy</button>
        <button type="button" name="insert_arg" id="insert_second_arg" value="Wpisz jako drugi" onclick="insertVariableToInput(`arg_second`, `variable_help`)">Wpisz jako drugi</button><br />
        <button type="button" name="swap_order" id="swap_order" value="Zamień kolejność" onclick="swapInputOrder()">Zamień kolejność</button><br />
        <select name="commands" id="commands">
            <option value="MOV" onclick="toggleSecondArg(true)">MOV</option>
            <option value="XCHG" onclick="toggleSecondArg(true)">XCHG</option>
            <option value="PUSH" onclick="toggleSecondArg(false)">PUSH</option>
            <option value="POP" onclick="toggleSecondArg(false)">POP</option>
        </select>
        <input type="text" name="arg_first" id="arg_first">,
        <input type="text" name="arg_second" id="arg_second">
        <button type="button" name="run_command" id="run_command" value="Wykonaj" onclick="runCommand(document.getElementById(`commands`).value, document.getElementById(`arg_first`).value, document.getElementById(`arg_second`).value)">Wykonaj</button><br><br />
        <p>Tryb adresowania pamięci: </p>
        <input type="radio" name="memory_address_mode" id="mem_add_indeksowy" value="Indeksowy" onclick="updateMemoryRegSelection(this.value)" />
        <label for="mem_add_indeksowy">Indeksowy</label>
        <input type="radio" name="memory_address_mode" id="mem_add_bazowy" value="Bazowy" onclick="updateMemoryRegSelection(this.value)" />
        <label for="mem_add_bazowy">Bazowy</label>
        <input type="radio" name="memory_address_mode" id="mem_add_indeksowo-bazowy" value="Indeksowo-bazowy" onclick="updateMemoryRegSelection(this.value)" />
        <label for="mem_add_indeksowo-bazowy">Indeksowo-bazowy</label><br /><br />
        <select name="memory_reg_selection" id="memory_reg_selection">
            <option value="Wybierz tryb adresacji">Wybierz tryb adresacji</option>
        </select><br />
        <button type="button" name="insert_mem_add" id="insert_mem_add_first" value="Wpisz pointer jako pierwszy" onclick="insertVariableToInput(`arg_first`, `memory_reg_selection`, true)">Wpisz pointer jako pierwszy</button>
        <button type="button" name="insert_mem_add" id="insert_mem_add_second" value="Wpisz pointer jako drugi" onclick="insertVariableToInput(`arg_second`, `memory_reg_selection`, true)">Wpisz pointer jako drugi</button><br />
    </div>
    <div id="log" class="default_segment">
        <p id="status_message">Log operacji: </p><span id="operation_return"></span>
    </div>
    <div id="memory" class="default_segment">
        <p id="memory_message">Pamięć: </p><span id="memory_return"></span>
    </div>
    <script>
        vars = ["AX", "BX", "CX", "DX", "BP", "DI", "SI", "DISP"];
        let SP = 0;
        stack = {};

        for (let i = 0; i < vars.length; i++) {
            vars[`${vars[i]}`] = "0000";
        }

        memory = {};
        hexRegex = /^[0-9a-fA-F]{4}$/;
        namingRegex = /^[A-Z]+$/;
        function setOperationMessage(message) {
            document.getElementById("operation_return").innerHTML += message + "<br>";
        }
        function updateGUI() {
            document.getElementById("ax_val").innerHTML = vars["AX"];
            document.getElementById("bx_val").innerHTML = vars["BX"];
            document.getElementById("cx_val").innerHTML = vars["CX"];
            document.getElementById("dx_val").innerHTML = vars["DX"];
            document.getElementById("bp_val").innerHTML = vars["BP"];
            document.getElementById("di_val").innerHTML = vars["DI"];
            document.getElementById("si_val").innerHTML = vars["SI"];
            document.getElementById("offset_val").innerHTML = vars["DISP"];
            document.getElementById("memory_return").innerHTML = JSON.stringify(memory).replace("{", "").replace("}", "").replaceAll("\"", "").replaceAll(",", "<br>");
            document.getElementById("stack_return").innerHTML = JSON.stringify(stack).replace("{", "").replace("}", "").replaceAll("\"", "").replaceAll(",", "<br>");
        }
        function runCommand(operation, argFirst, argSecond) {
            let valid = false;
            let invalidArg = argFirst;

            if (typeof (vars[`${argFirst}`]) !== "undefined" && namingRegex.test(argFirst)) {
                if (operation == "MOV") {
                    if (!namingRegex.test(argSecond) && !hexRegex.test(argSecond) && !checkIfPointer(argSecond)) {
                        console.log(`BAD SECOND ARG`)
                        invalidArg = argSecond;
                    } else {
                        console.log(`${namingRegex.test(argSecond)} ${hexRegex.test(argSecond)}`)
                        vars[`${argFirst}`] = typeof (vars[`${argSecond}`]) !== "undefined" ? vars[`${argSecond}`] : checkIfPointer(argSecond) ? typeof (memory[`${hexMath(argSecond)}`]) !== "undefined" ? memory[`${hexMath(argSecond)}`] : "0000" : hexRegex.test(argSecond) ? argSecond : "0000";
                        valid = true;
                    }
                }
                else if (operation == "XCHG") {
                    if (checkIfPointer(argSecond) && typeof (memory[`${hexMath(argSecond)}`]) !== "undefined") {
                        console.log(argSecond + " is pointer");
                        let temp = memory[`${hexMath(argSecond)}`];
                        memory[`${hexMath(argSecond)}`] = vars[`${argFirst}`];
                        vars[`${argFirst}`] = temp;
                        valid = true;
                    }
                    else if (!namingRegex.test(argSecond) || typeof (vars[`${argSecond}`]) === "undefined") {
                        invalidArg = argSecond;
                    } else {
                        console.log(`${argSecond} is not pointer and is var`);
                        let temp = vars[`${argFirst}`];
                        vars[`${argFirst}`] = vars[`${argSecond}`];
                        vars[`${argSecond}`] = temp;
                        valid = true;
                    }
                }
                if (operation == "PUSH") {
                    stack = { ...stack, SP: vars[`${argFirst}`] };
                    valid = true;
                    setOperationMessage(`${operation} ${argFirst}`);
                } else if (operation == "POP") {
                    vars[`${argFirst}`] = stack[`${SP}`];
                    valid = true;
                    setOperationMessage(`${operation} ${argFirst}`);
                } else {
                    setOperationMessage(`${operation} ${argFirst}, ${typeof (vars[`${argSecond}`]) !== "undefined" ? argSecond : checkIfPointer(argSecond) ? argSecond : hexRegex.test(argSecond) ? argSecond : "0000"}`);
                }
                updateGUI();
            }
            else if (checkIfPointer(argFirst)) {
                let memoryAddress = hexMath(argFirst);
                if (hexRegex.test(memoryAddress)) {
                    if (operation == "MOV") {
                        if (!namingRegex.test(argSecond) && !hexRegex.test(argSecond) && !checkIfPointer(argSecond)) {
                            console.log(`BAD SECOND ARG`)
                            invalidArg = argSecond;
                        } else {
                            memory[`${memoryAddress}`] = typeof (vars[`${argSecond}`]) !== "undefined" ? vars[`${argSecond}`] : hexRegex.test(argSecond) ? argSecond : "0000";
                            valid = true;
                        }
                    }
                    else if (operation == "XCHG") {
                        if (typeof (memory[`${memoryAddress}`]) === "undefined") {
                            invalidArg = argSecond;
                        } else {
                            let temp = memory[`${memoryAddress}`];
                            memory[`${memoryAddress}`] = vars[`${argSecond}`];
                            vars[`${argSecond}`] = temp;
                            valid = true;
                        }
                    }
                    setOperationMessage(`${operation} ${argFirst}, ${typeof (vars[`${argSecond}`]) !== "undefined" ? argSecond : hexRegex.test(argSecond) ? argSecond : "0000"}`);
                    updateGUI();
                }
                else {
                    setOperationMessage(`INVALID MEMORY ADDRESS \"${memoryAddress}\"`);
                }
            }
            if (!valid) setOperationMessage(`INVALID ARGUMENT \"${invalidArg}\"`);
        }

        function checkIfPointer(arg) {
            return arg.slice(0, 1) === "[" && arg.slice(-1) === "]";
        }

        function hexMath(calculation) {

            calculation = calculation.replaceAll(" ", "").replaceAll("[", "").replaceAll("]", "");
            components = calculation.split("+");
            for (let i = 0; i < components.length; i++) {
                if ((typeof (vars[`${components[i]}`]) !== "undefined" && namingRegex.test(components[i]))) {
                    components[i] = vars[`${components[i]}`];
                }
            }
            calculation = components.reduce((a, b) => parseInt(a, 16) + parseInt(b, 16)).toString(16);
            console.log(components);
            return calculation.padStart(4, '0');
        }
        function emptyTable(tableId) {
            for (let i = tableId * 4; i < tableId * 4 + 4; i++) {
                runCommand("MOV", `${vars[i]}`, "0000");
            }
        }
        function randomizeTable(tableId) {
            for (let i = tableId * 4; i < tableId * 4 + 4; i++) {
                runCommand("MOV", `${vars[i]}`, Math.floor(Math.random() * 65535).toString(16).padStart(4, '0'));
            }
        }

        function insertVariableToInput(inputId, selectorId, isPointer = false) {
            document.getElementById(`${inputId}`).value = `${isPointer ? "[" : ""}${document.getElementById(`${selectorId}`).value}${isPointer ? "+DISP]" : ""}`;
        }

        function swapInputOrder() {
            let temp = document.getElementById("arg_first").value;
            document.getElementById("arg_first").value = document.getElementById("arg_second").value;
            document.getElementById("arg_second").value = temp;
        }

        function updateMemoryRegSelection(mode) {
            options = {};
            console.log(mode);

            let memoryRegSelection = document.getElementById("memory_reg_selection");
            memoryRegSelection.innerHTML = "";

            switch (mode)
            {
                case "Indeksowy":
                    console.log("Indeksowy");
                    options = { "DI": "DI", "SI": "SI" };
                    break;
                case "Bazowy":
                    options = { "BX": "BX", "BP": "BP" };
                    break;
                case "Indeksowo-bazowy":
                    options = { "SI+BX": "SI+BX", "SI+BP": "SI+BP", "DI+BX": "DI+BX", "DI+BP": "DI+BP" };
                    break;
                default:
                    options = { "Wybierz tryb adresacji": "Wybierz tryb adresacji" };
                    break;
            }
            console.log(options.length);
            for (let key in options) {
                if (options.hasOwnProperty(key)) {
                    let option = document.createElement("option");
                    option.value = key;
                    option.text = options[key];
                    memoryRegSelection.add(option);
                }
            }
        }

        function toggleSecondArg(on) {
            document.getElementById("arg_second").disabled = !on;
        }

        console.log(vars);
        updateGUI();
    </script>
</body>
</html>